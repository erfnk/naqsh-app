datasource db {
  provider = "postgresql"
}

generator client {
  provider   = "prisma-client"
  output     = "./generated"
  engineType = "client"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./zod"
  config   = "./zod-generator.config.json"
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  locale             String?
  displayUsername    String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  members            Member[]
  twofactors         TwoFactor[]
  createdBoards      Board[]         @relation("boardCreator")
  boardFavorites     BoardFavorite[]
  boardAccesses      BoardAccess[]
  assignedTasks      Task[]          @relation("taskAssignee")
  createdTasks       Task[]          @relation("taskCreator")

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@index([identifier])
  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  aaguid       String?
  createdAt    DateTime?

  @@index([userId])
  @@index([credentialID])
  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([secret])
  @@index([userId])
  @@map("twoFactor")
}

model Organization {
  id                 String       @id @default(cuid())
  name               String
  slug               String?
  logo               String?
  createdAt          DateTime
  metadata           String?
  members            Member[]
  invitations        Invitation[]
  boards             Board[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

model Board {
  id             String          @id @default(cuid())
  title          String
  slug           String?
  description    String?
  organizationId String
  createdById    String
  visibility     String          @default("private")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User            @relation("boardCreator", fields: [createdById], references: [id], onDelete: Cascade)
  columns        Column[]
  tasks          Task[]
  favorites      BoardFavorite[]
  accesses       BoardAccess[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([createdById])
  @@map("board")
}

model BoardFavorite {
  id        String   @id @default(cuid())
  boardId   String
  userId    String
  createdAt DateTime @default(now())

  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([userId])
  @@map("board_favorite")
}

model BoardAccess {
  id             String   @id @default(cuid())
  boardId        String
  userId         String
  lastAccessedAt DateTime @default(now())

  board          Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@index([userId])
  @@index([lastAccessedAt])
  @@map("board_access")
}

model Column {
  id        String   @id @default(cuid())
  boardId   String
  title     String
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([boardId])
  @@map("column")
}

model Task {
  id          String   @id @default(cuid())
  columnId    String
  boardId     String
  title       String
  description String?  @db.Text
  priority    String   @default("medium")
  position    Int
  assigneeId  String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  column      Column   @relation(fields: [columnId], references: [id], onDelete: Cascade)
  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  assignee    User?    @relation("taskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  createdBy   User     @relation("taskCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([columnId])
  @@index([boardId])
  @@index([assigneeId])
  @@map("task")
}
