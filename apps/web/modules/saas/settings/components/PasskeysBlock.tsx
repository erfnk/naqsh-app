"use client";
import { authClient } from "@repo/auth/client";
import { Button } from "@repo/ui/components/button";
import { Skeleton } from "@repo/ui/components/skeleton";
import {
	toastError,
	toastPromise,
	toastSuccess,
} from "@repo/ui/components/toast";
import { userPasskeyQueryKey, useUserPasskeysQuery } from "@saas/auth/lib/api";
import { SettingsItem } from "@saas/shared/components/SettingsItem";
import { useQueryClient } from "@tanstack/react-query";
import { HugeiconsIcon } from "@hugeicons/react";
import { Key01Icon, PlusSignIcon, Delete01Icon } from "@hugeicons/core-free-icons";
import { useFormatter, useTranslations } from "next-intl";

export function PasskeysBlock() {
	const t = useTranslations();
	const queryClient = useQueryClient();
	const formatter = useFormatter();

	const { data: passkeys, isPending } = useUserPasskeysQuery();

	const addPasskey = async () => {
		await authClient.passkey.addPasskey({
			fetchOptions: {
				onSuccess: () => {
					queryClient.invalidateQueries({
						queryKey: userPasskeyQueryKey,
					});
					toastSuccess(
						t(
							"settings.account.security.passkeys.notifications.addPasskey.success.title",
						),
					);
				},
				onError: () => {
					toastError(
						t(
							"settings.account.security.passkeys.notifications.addPasskey.error.title",
						),
					);
				},
			},
		});
	};

	const deletePasskey = (id: string) => {
		toastPromise(
			async () => {
				await authClient.passkey.deletePasskey({
					id,
					fetchOptions: {
						onSuccess: () => {
							queryClient.invalidateQueries({
								queryKey: userPasskeyQueryKey,
							});
						},
					},
				});
			},
			{
				loading: t(
					"settings.account.security.passkeys.notifications.deletePasskey.loading.title",
				),
				success: t(
					"settings.account.security.passkeys.notifications.deletePasskey.success.title",
				),
				error: t(
					"settings.account.security.passkeys.notifications.deletePasskey.error.title",
				),
			},
		);
	};

	return (
		<SettingsItem
			title={t("settings.account.security.passkeys.title")}
			description={t("settings.account.security.passkeys.description")}
		>
			<div className="grid grid-cols-1 gap-2">
				{isPending ? (
					<div className="flex gap-2">
						<Skeleton className="size-6 shrink-0" />
						<div className="flex-1">
							<Skeleton className="mb-0.5 h-4 w-full" />
							<Skeleton className="h-8 w-full" />
						</div>
						<Skeleton className="size-9 shrink-0" />
					</div>
				) : (
					passkeys?.map((passkey) => (
						<div key={passkey.id} className="flex gap-2">
							<HugeiconsIcon icon={Key01Icon} className="size-6 shrink-0 text-primary/50" strokeWidth={2} />
							<div className="flex-1">
								<strong className="block text-sm">
									{passkey.deviceType} {passkey.name}
								</strong>
								<small className="block text-foreground/60 text-xs leading-tight">
									{formatter.dateTime(
										new Date(passkey.createdAt),
									)}
								</small>
							</div>
							<Button
								variant="secondary"
								size="icon"
								className="shrink-0"
								onClick={() => deletePasskey(passkey.id)}
							>
								<HugeiconsIcon icon={Delete01Icon} className="size-4" strokeWidth={2} />
							</Button>
						</div>
					))
				)}

				<div className="flex justify-start">
					<Button variant="secondary" onClick={addPasskey}>
						<HugeiconsIcon icon={PlusSignIcon} className="mr-1.5 size-4" strokeWidth={2} />
						Add passkey
					</Button>
				</div>
			</div>
		</SettingsItem>
	);
}
